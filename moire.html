<html>

<body onload="draw();">

  <div style="margin-bottom: 15px;">
    <img src="https://www.asahi-kasei.com/common/images/logo-01.png" height="20" />
  </div>

  <div>
    <label for="canvasSizeX">x (px)</label>
    <input id="canvasSizeX" type="text" value="800" name="canvasSizeX" maxLength="4" size="4" />
    <label for="canvasSizeY">y (px)</label>
    <input id="canvasSizeY" type="text" value="800" name="canvasSizeY" maxLength="4" size="4" />
  </div>
  <div>
    <label for="density">Density</label>
    <input id="density" type="text" value="4" name="density" maxLength="2" size="2" />
  </div>
  <div>
    <label for="pixelPattern">Pixel Pattern</label>
    <select id="pixelPattern" name="pixelPattern">
      <option value="iPhone5s" selected>iPhone 5s</option>
      <option value="iPhone11Pro">iPhone 11 Pro</option>
    </select>
  </div>
  <div>
    <label for="pixelSize">Pixel Size (um)</label>
    <input id="pixelSize" type="text" value="78" name="pixelSize" maxlength="5" size="5" />
    (iPhone 5S: 78 um, iPhone 11 Pro: 55.5 um)
  </div>
  <div>
    <label for="gridPitch">Grid Pitch (um)</label>
    <input id="gridPitch" type="text" value="60" name="gridPitch" maxlength="5" size="5" />
  </div>
  <div>
    <label for="lineWidth">Line Width (um)</label>
    <input id="lineWidth" type="text" value="13" name="lineWidth" maxlength="2" size="2" />
  </div>
  <div>
    <label for="angle">Angle</label>
    <select id="angle" name="angle">
      <option value="0" selected>0&deg;</option>
      <option value="45">45&deg;</option>
    </select>
  </div>
  <div>
    <button onClick="draw()">draw</button>
    <!-- 
      Download image, refer to https://qiita.com/iwaimagic/items/1d16a721b36f04e91aed
    -->
    <button onclick="downloadCanvas()">Download</button>
    <div style="display: none;">
      <a id="hiddenLink" download="canvas.png">link</a>
    </div>
    <script type="text/javascript">
    function downloadCanvas() {
      let canvas = document.getElementById('myCanvas');
      let link = document.getElementById('hiddenLink');
      link.href = canvas.toDataURL();
//      document.getElementById('canvasImage').src = canvas.toDataURL();
      link.click()
    }
    </script>
  </div>

  <div id="canvasArea">
    <canvas id="myCanvas">your browser does not support the canvas tag</canvas>
  </div>


  <script type="text/javascript">
    function draw(){
      //
      // Setup
      //
      let canvas = document.getElementById("myCanvas");
      let ctx = canvas.getContext("2d");

      // Set apparent canvas size
      // If you feel awkward about '+', see the link below:
      // https://stackoverflow.com/questions/24355508/using-a-textbox-to-take-in-an-integer-value-for-use-in-javascript-function-is-t
      let width = +document.getElementById('canvasSizeX').value;
      let height = +document.getElementById('canvasSizeY').value;
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      console.log("canvas.style.width = " + canvas.style.width);
      console.log("canvas.style.height = " + canvas.style.height);

      // Set scale
      let scale = +document.getElementById('density').value;
      console.log("Display scale is " + scale);

      // Set drawable canvas size
      canvas.width = width * scale;
      canvas.height = height * scale;
      console.log("Canvas size is " + canvas.width + "x" + canvas.height);

      // Fill background
      ctx.fillStyle = "rgb(0,0,0)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      //
      // Draw pixels
      //
      let pixelSize = +document.getElementById('pixelSize').value;
      let delta = pixelSize / 3;
      let margin = pixelSize / 12;
      let normGreen = Math.sqrt((pixelSize/2.0-2.0*margin)*(pixelSize/2.0-2.0*margin)/2.0); // length of green dot
      let pixelPattern = document.getElementById('pixelPattern').value;
      console.log("pixelSize is " + pixelSize + ", delta is " + delta + ".");
      for(i=0; i < canvas.width; i=i+pixelSize){
        for(j=0; j < canvas.height; j=j+pixelSize){
          if(pixelPattern == 'iPhone5s'){
            ctx.fillStyle = "rgb(255, 64, 64)";
            ctx.fillRect(i, j+delta, delta, pixelSize-delta);
            ctx.fillStyle = "rgb( 64, 255, 64)";
            ctx.fillRect(i+delta, j+delta, delta, pixelSize-delta);
            ctx.fillStyle = "rgb( 64, 64, 255)";
            ctx.fillRect(i+2*delta, j+delta, delta, pixelSize-delta);
          } else {  // iPhone 11 Pro
            ctx.fillStyle = "rgb(255, 64, 64)";
            ctx.fillRect(i + margin, j + margin, pixelSize/2 - 2*margin, pixelSize/2 - 2*margin);
            ctx.fillStyle = "rgb( 64, 255, 64)";
            ctx.fillRect(i + 3*pixelSize/4 - normGreen/2, j + pixelSize/4 - normGreen/2, normGreen, normGreen);
            ctx.fillRect(i + 1*pixelSize/4 - normGreen/2, j + 3*pixelSize/4 - normGreen/2, normGreen, normGreen);
            ctx.fillStyle = "rgb(64, 64, 255)";
            ctx.fillRect(i + pixelSize/2 + margin, j + pixelSize/2 + margin, pixelSize/2 - 2*margin, pixelSize/2 - 2*margin);
          }
        }
      }

      //
      // Draw grids
      //
      let pitch = +document.getElementById('gridPitch').value;
      let lineWidth = +document.getElementById('lineWidth').value;
      let angle = +document.getElementById('angle').value;
      ctx.lineWidth = lineWidth;
      ctx.strokeStyle = "rgb(0, 0, 0)";
      if(angle == 0) {
        // x
        for(i=0; i < canvas.width; i=i+pitch){
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
        }
        // y
        for(j=0; j < canvas.height; j=j+pitch){
          ctx.beginPath();
          ctx.moveTo(0, j);
          ctx.lineTo(canvas.width, j);
          ctx.stroke();
        }
      } else {
        // 45 deg
        for(i=0; i <= canvas.width*2; i=i+pitch*Math.sqrt(2)){
          ctx.beginPath();
          ctx.moveTo(i,0);
          ctx.lineTo(0,i);
          ctx.lineTo(canvas.width*2-i, canvas.width*2);
          ctx.lineTo(canvas.width*2, canvas.width*2-i);
          ctx.lineTo(i,0);
          ctx.stroke();
        }
      }

      //
      // draw parameters
      //
      let info = "Pixel Pitch: " + pixelSize + " um, "
                   + "Grid Pitch: " + pitch + " um, "
                   + "Line Width: " + lineWidth + " um";

      ctx.scale(scale, scale);

      let margin_x = 10; // px
      let margin_y = 10; // px
      let padding_x = 3; // px
      let padding_y = 3; // px

      ctx.textBaseline = "top";
      ctx.font = "12px serif";

      let textWidth = ctx.measureText(info).width;
      // Approximately, see https://stackoverflow.com/a/13318387
      let textHeight = ctx.measureText('M').width; 

      // Draw box
      ctx.fillStyle = "white";
      ctx.fillRect(margin_x, margin_y, textWidth + 2*padding_x, textHeight + 2*padding_y);

      // Draw text
      ctx.fillStyle = "black";
      ctx.fillText(info, margin_x + padding_x, margin_y + padding_y);

      ctx.scale(1.0, 1.0);
    }
  </script>  
  
</body>

</html>
