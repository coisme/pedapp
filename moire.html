<html>

<body onload="draw();">

  <div style="margin-bottom: 15px;">
    <img src="https://www.asahi-kasei.com/common/images/logo-01.png" height="20" />
  </div>

  <div>
    <label for="numOfPixelsX">Number of Pixels (X)</label>
    <input id="numOfPixelsX" type="text" value="50" name="numOfPixelsX" maxLength="4" size="4" />
    <label for="numOfPixelsY">Number of Pixels (Y)</label>
    <input id="numOfPixelsY" type="text" value="30" name="numOfPixelsY" maxLength="4" size="4" />
    <div>
      (iPhone 5S: 1136 x 640, iPhone 11 Pro: 2688 x 1242)
    </div>
  </div>
  <div>
    <label for="density">Density</label>
    <input id="density" type="text" value="0" name="density" maxLength="2" size="2" />
  </div>
  <div>
    <label for="pixelPattern">Pixel Pattern</label>
    <select id="pixelPattern" name="pixelPattern">
      <option value="iPhone5s" selected>iPhone 5s</option>
      <option value="iPhone11Pro">iPhone 11 Pro</option>
    </select>
  </div>
  <div>
    <label for="pixelSize">Pixel Size (um)</label>
    <input id="pixelSize" type="text" value="78" name="pixelSize" maxlength="5" size="5" />
    (iPhone 5S: 78 um, iPhone 11 Pro: 55.5 um)
  </div>
  <div>
    <label for="isDrawGrid">Draw Grid</label>
    <input type="checkbox" id="isDrawGrid" name="isDrawGrid" value="draw" checked />
  </div>
  <div>
    <label for="gridPitch">Grid Pitch (um)</label>
    <input id="gridPitch" type="text" value="60" name="gridPitch" maxlength="5" size="5" />
  </div>
  <div>
    <label for="lineWidth">Line Width (um)</label>
    <input id="lineWidth" type="text" value="10" name="lineWidth" maxlength="2" size="2" />
  </div>
  <div>
    <label for="angle">Angle</label>
    <select id="angle" name="angle">
      <option value="0" selected>0&deg;</option>
      <option value="45">45&deg;</option>
    </select>
  </div>
  <div>
    <label for="phaseX">Phase X(&deg;)</label>
    <input id="phaseX" type="text" value="0" name="phaseX" maxlength="4" size="4" />
    <label for="phaseY">Phase Y(&deg;)</label>
    <input id="phaseY" type="text" value="0" name="phaseY" maxlength="4" size="4" />
  </div>
  <div>
    <button onClick="draw()">draw</button>
    <!-- 
      Download image, refer to https://qiita.com/iwaimagic/items/1d16a721b36f04e91aed
    -->
    <button onclick="downloadCanvas()">Download</button>
    <div style="display: none;">
      <a id="hiddenLink" download="canvas.png">link</a>
    </div>
    <script type="text/javascript">
    function downloadCanvas() {
      let canvas = document.getElementById('myCanvas');
      let link = document.getElementById('hiddenLink');
      link.href = canvas.toDataURL();
//      document.getElementById('canvasImage').src = canvas.toDataURL();
      link.click()
    }
    </script>
  </div>

  <div id="canvasArea">
    <canvas id="myCanvas">your browser does not support the canvas tag</canvas>
  </div>
  <div>
    <canvas id="zoom" width="400" height="200">your browser does not support the canvas tag</canvas>
  </div>

  <script type="text/javascript">
    function draw(){
      //
      // Setup
      //
      let canvas = document.getElementById("myCanvas");
      let ctx = canvas.getContext("2d");

      // Disable image smoothing
      // See: https://developer.mozilla.org/ja/docs/Web/Guide/HTML/Canvas_tutorial/Using_images#Controlling_image_scaling_behavior
      ctx.mozImageSmoothingEnabled = false;
      ctx.webkitImageSmoothingEnabled = false;
      ctx.msImageSmoothingEnabled = false;
      ctx.imageSmoothingEnabled = false;

      // Set scale
      // If you feel awkward about '+', see the link below:
      // See: https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio
      let density = +document.getElementById('density').value;
      let scale = density;
      if(density < 0.1){
        // Set default if density == 0
        scale = window.devicePixelRatio || 1;
        document.getElementById('density').value = scale;
      }
      console.log("Display scale is " + scale);

      // Size of a pixel
      // https://stackoverflow.com/questions/24355508/using-a-textbox-to-take-in-an-integer-value-for-use-in-javascript-function-is-t
      let pixelSize = +document.getElementById('pixelSize').value;
      console.log("Pixel size is " + pixelSize);

      // Set drawable canvas size
      let numOfPixelsX = +document.getElementById('numOfPixelsX').value;
      let numOfPixelsY = +document.getElementById('numOfPixelsY').value;
      canvas.width = pixelSize * numOfPixelsX;
      canvas.height = pixelSize * numOfPixelsY;
      console.log("Drawable canvas size is " + canvas.width + "x" + canvas.height);

      // Set apparent canvas size
      let width = canvas.width / scale;
      let height = canvas.height / scale;
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      console.log("canvas.style.width = " + canvas.style.width);
      console.log("canvas.style.height = " + canvas.style.height);

      // Fill background
      ctx.fillStyle = "rgb(0,0,0)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      //
      // Draw pixels
      //
      let delta = pixelSize / 3;
      let margin = pixelSize / 16;
      let normGreen = Math.sqrt((pixelSize/2.0-2.0*margin)*(pixelSize/2.0-2.0*margin)/2.0); // length of green dot
      let pixelPattern = document.getElementById('pixelPattern').value;
      console.log("pixelSize is " + pixelSize + ", delta is " + delta + ".");
      // Create a pixel (pre-rendering)
      // See: https://www.html5rocks.com/ja/tutorials/canvas/performance/#toc-pre-render
      var m_canvas = document.createElement('canvas');
      m_canvas.width = pixelSize;
      m_canvas.height = pixelSize;
      var m_ctx = m_canvas.getContext('2d');
      if(pixelPattern == 'iPhone5s'){
        m_ctx.fillStyle = "rgb(255, 64, 64)";
        m_ctx.fillRect(0, delta, delta, pixelSize-delta);
        m_ctx.fillStyle = "rgb( 64, 255, 64)";
        m_ctx.fillRect(delta, delta, delta, pixelSize-delta);
        m_ctx.fillStyle = "rgb( 64, 64, 255)";
        m_ctx.fillRect(2*delta, delta, delta, pixelSize-delta);
      } else {  // iPhone 11 Pro
        m_ctx.fillStyle = "rgb(255, 64, 64)";
        m_ctx.fillRect(margin, margin, pixelSize/2 - 2*margin, pixelSize/2 - 2*margin);
        m_ctx.fillStyle = "rgb( 64, 255, 64)";
        m_ctx.fillRect(3*pixelSize/4 - normGreen/2, pixelSize/4 - normGreen/2, normGreen, normGreen);
        m_ctx.fillRect(1*pixelSize/4 - normGreen/2, 3*pixelSize/4 - normGreen/2, normGreen, normGreen);
        m_ctx.fillStyle = "rgb(64, 64, 255)";
        m_ctx.fillRect(pixelSize/2 + margin, pixelSize/2 + margin, pixelSize/2 - 2*margin, pixelSize/2 - 2*margin);
      }
      // Fill the area with pixels
      for(i=0; i < canvas.width; i=i+pixelSize){
        for(j=0; j < canvas.height; j=j+pixelSize){
          ctx.drawImage(m_canvas, i, j);
        }
      }

      //
      // Draw grids
      //
      let pitch = +document.getElementById('gridPitch').value;
      let lineWidth = +document.getElementById('lineWidth').value;
      let angle = +document.getElementById('angle').value;
      let shiftX = pitch * document.getElementById('phaseX').value / 360.0;
      let shiftY = pitch * document.getElementById('phaseY').value / 360.0;
      ctx.lineWidth = lineWidth;
      ctx.strokeStyle = "rgb(60, 60, 60)";
      let isDrawGrid = document.getElementById('isDrawGrid').checked;
      if(isDrawGrid) {
        if(angle == 0) {
        // x
        for(i=shiftX; i < canvas.width; i=i+pitch){
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
        }
        // y
        for(j=shiftY; j < canvas.height; j=j+pitch){
          ctx.beginPath();
          ctx.moveTo(0, j);
          ctx.lineTo(canvas.width, j);
          ctx.stroke();
        }
        } else {
          // 45 deg
          for(i=shiftX; i <= canvas.width*2; i=i+pitch*Math.sqrt(2)){
            ctx.beginPath();
            ctx.moveTo(i,0);
            ctx.lineTo(0,i);
            ctx.lineTo(canvas.width*2-i, canvas.width*2);
            ctx.lineTo(canvas.width*2, canvas.width*2-i);
            ctx.lineTo(i,0);
            ctx.stroke();
          }
        }
      }

      //
      // draw parameters
      //
      let info =  "Pattern: " + pixelPattern + ", "
                   + numOfPixelsX + " x " + numOfPixelsY + " pixels, "
                   + "Pixel Pitch: " + pixelSize + " um, "
                   + "Grid Pitch: " + pitch + " um, "
                   + "Line Width: " + lineWidth + " um"
                   + "Angle: " + angle + " deg";

      ctx.scale(scale, scale);

      let margin_x = 10; // px
      let margin_y = 10; // px
      let padding_x = 3; // px
      let padding_y = 3; // px

      ctx.textBaseline = "top";
      ctx.font = "12px serif";

      let textWidth = ctx.measureText(info).width;
      // Approximately, see https://stackoverflow.com/a/13318387
      let textHeight = ctx.measureText('M').width; 

      // Draw box
      ctx.fillStyle = "white";
      ctx.fillRect(margin_x, margin_y, textWidth + 2*padding_x, textHeight + 2*padding_y);

      // Draw text
      ctx.fillStyle = "black";
      ctx.fillText(info, margin_x + padding_x, margin_y + padding_y);
    }
  </script>  
  
</body>

</html>
